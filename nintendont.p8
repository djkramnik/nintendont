pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
inity=96
nx=16
ny=inity
leftie=false
jumping=false
jtick=0
jdiv=8
jbtn=false
vdisp=0
initv=15
v=0
g=9
btntick=0
btnrls=false
-- horizontal speed saga
hv=0
speed=0
running=false
maxrun=2.5
maxwalk=1.2
slowdown=false
maxspeed=0
spover=-1
ass="???"
fallmax=4

function _update()
  local t=0
  local powa=0
  local ydelta =0
  local nxtvdisp = 0
  
  ass=touchgrass(nx,ny)
  -- extract out hv manip?  negative if leftie? if/elseif/else block at beginning?
  if (btn(0)) then
    leftie=true
    --nx-=1
    if (running and not jumping) then
     hv=-0.15
    else
     hv=-0.1
    end
   end

   if (btn(1)) then
    --nx+=1
    leftie=false
    if(running and not jumping) then
     hv=0.15
    else
     hv=0.1
    end
  end

  if (not btn(0) and not btn(1)) then
    if (speed > 0) then
      hv=-0.05
    elseif (speed < 0) then
      hv=0.05
    else
      hv=0
    end
  end
  if (btn(4)) then
    jbtn=true
  else
    jbtn=false
  end
  
  if (btn(5)) then
   running = true
  else
   running=false
  end
  
  powa=abs(speed)
  
  slowdown = powa <= maxrun 
  and powa > maxwalk 
  and not running
  
  if(not jumping) then
   local jtest=bejump(false,jbtn,ass)
  
  if (jtest) then
    if (jbtn) then
     initv = running and 18 or 15
    else
     initv = 0
    end
  end  
  end
  -- i no this is fucked but i need this
  jumping= bejump(jumping,jbtn,ass)
  
  if(jumping) then
    v=initv
    jtick+=1
    t=(jtick/jdiv)
    if (jbtn and not btnrls and jtick<10) then
     btntick+=0.5
    else
     btnrls=true
    end
    v=initv+(btntick)
    nxtvdisp = ydiff(v,t,g)
    ydelta=nxtvdisp - vdisp
    ydelta=min(
    max(ydelta,fallmax*-1),
    fallmax)
    
    vdisp=nxtvdisp
  else
    v=0
    jtick=0
    vdisp=0
    ny=inity
    btntick=0
    btnrls=false
  end
  
  if (slowdown) then
   maxspeed=powa
   --decrease our actual speed until we at max walk speed again
     if (speed > 0) then
      hv=-0.05
     else
      hv=0.05
     end
  elseif (running) then
   maxspeed=maxrun
  else
   maxspeed=maxwalk
  end
  
  speed = max(min(speed+hv
  ,maxspeed),maxspeed*-1)
  
  if (abs(speed) < 0.1) then
   speed=0
  end
  
  if (jumping) then
   nx+=(speed/1.1)
  else
   nx+=speed
  end 
  
  ny -= ydelta
  if (ny > 128) then
   ny = 0
  end

end

function _draw()
 cls()
 spr(1,nx,ny,1,1,leftie)
 map()
 print(jumping)
 print(ass)
 print(ny)
 --print("wtf"..tostr(mget(7,10)))
 --print(vdisp)
 --print(running)
 --print(jumping)
 --print("speed: "..tostr(speed))
 --print("maxspeed: "..tostr(maxspeed))
 --print("slowdown?: "..tostr(slowdown))
 --print(inity)
 --print(ny-vdisp)
end

-->8
function bejump(prev,jbtn,ass)
  return not ass or (jbtn and not prev)
end

function ydiff(v,t,g)
 return (v*t) - (0.5*g*t*t)
end

function touchgrass(x,y)
  lx = x+1
  ly = y+8
  rx = x+6
  ry = y+8
  
  cxl = flr(lx/8)
  cyl = flr(ly/8)
  cxr = flr(rx/8)
  cyr = flr(ry/8)
  
  lt = mget(cxl,cyl) == 2
  rt = mget(cxr,cyr) == 2
  
  return lt or rt
end
__gfx__
0000000008888880bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000008822280bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070008e2e2804444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700008e222804444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700008eee2804444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070008e2e2804444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000008eee8804444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000078888704444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020303020202020202020203000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
